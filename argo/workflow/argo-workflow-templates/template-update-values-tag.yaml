apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: application-values-tag-updater
spec:
  entrypoint: update-values-tag
  serviceAccountName: argo-workflow-svc
  volumeClaimTemplates:
    - metadata:
        name: workdir
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 1Gi

  arguments:
    parameters:
      - name: git-application-values
        value: https://github.com/MatiWall/homelab.application-values.git
      - name: base-image
        value: python:3.12-2
      - name: email
      - name: username
      - name: application-name
      - name: version

  templates:
    - name: update-values-tag
      steps:
        - - name: cloner
            template: cloner
            arguments:
              parameters:
                - name: git-application-values
                  value: "{{workflow.parameters.git-application-values}}"
        - - name: find-application
            template: find-application
            arguments:
              parameters:
                - name: application-name
                  value: "{{workflow.parameters.application-name}}"
                - name: base-image
                  value: "{{workflow.parameters.base-image}}"
        - - name: update-yaml
            template: update-yaml
            arguments:
              parameters:
                - name: base-image
                  value: "{{workflow.parameters.base-image}}"
                - name: version
                  value: "{{workflow.parameters.version}}"
        - - name: git-push
            templateRef:
              name: git-push-template
              template: git-push
            arguments:
              parameters:
                - name: username
                  value: "{{workflow.parameters.username}}"
                - name: email
                  value: "{{workflow.parameters.email}}"

    - name: cloner
      inputs:
        parameters:
          - name: git-application-values
      container:
        image: alpine/git:latest
        command: [sh, -c]
        args:
          - |
            git clone "{{inputs.parameters.git-application-values}}"
        workingDir: /src
        volumeMounts:
          - name: workdir
            mountPath: /src

    - name: find-application
      inputs:
        parameters:
          - name: application-name
      script:
        image: "alpine:latest"
        command: [sh]
        source: |
          APPLICATIONS_PATHS=$(grep -rl "{{inputs.parameters.application-name}}" /src) 
          for path in $APPLICATIONS_PATHS; 
          do
            if [[ ${path##*/} == "Chart.yaml" ]]; 
            then
              APPLICATION_PATH="$path"
              break
            fi
          done
          VALUES_PATH=$(echo "$APPLICATION_PATH" | sed 's/Chart.yaml$/values.yaml/')
          echo "VALUES_PATH=$VALUES_PATH" > /tmp/values_path.txt
        workingDir: /src
        volumeMounts:
          - name: workdir
            mountPath: /src

    - name: update-yaml
      inputs:
        parameters:
          - name: base-image
          - name: version
      script:
        image: "{{inputs.parameters.base-image}}"
        command: [python]
        source: |
          import yaml

          with open("/tmp/values_path.txt") as f:
              values_path = f.read().strip().split('=')[1]

          with open(values_path, 'r') as f:
              data = yaml.safe_load(f)

          if data.get('cronjob').
              application-type = 'cronjob'
          elif data.get('deployment'):
              application_type = 'depployment'
          else:
              raise ValueError('values.yaml does not include either a cronjob or deployment key')
          data[application_type]['image']['tag'] = {{input.parameters.version}}

          with open(values_path, 'w') as f:
              yaml.safe_dump(data, f, default_flow_style=False, sort_keys=False)
        workingDir: /src
        volumeMounts:
          - name: workdir
            mountPath: /src
          - name: workdir
            mountPath: /tmp
